name: Quarterly Dependency Update

# Run quarterly to check for major updates and outdated dependencies
# Dependabot handles minor/patch updates automatically
on:
  schedule:
    # Run on the 1st day of January, April, July, October at 08:00 UTC
    - cron: '0 8 1 1,4,7,10 *'

  # Allow manual triggering
  workflow_dispatch:

jobs:
  check-updates:
    name: Check for Outdated Dependencies
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated packages
        id: outdated
        run: |
          echo "## ðŸ“¦ Outdated Dependencies Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npm outdated || true >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          # Save outdated list
          npm outdated --json > outdated.json || true

      - name: Run security audit
        run: |
          echo "## ðŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate || true

      - name: Check for major updates
        run: |
          echo "## ðŸš€ Available Major Updates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review these manually as they may contain breaking changes:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Use npx to check for major updates with npm-check-updates
          npx npm-check-updates --target major || true

      - name: Create issue if updates available
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Read outdated packages
            let outdatedCount = 0;
            try {
              const outdated = JSON.parse(fs.readFileSync('outdated.json', 'utf8'));
              outdatedCount = Object.keys(outdated).length;
            } catch (e) {
              console.log('No outdated packages found');
            }

            if (outdatedCount > 0) {
              // Create an issue
              const date = new Date().toISOString().split('T')[0];
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Quarterly] Dependency Updates Available - ${date}`,
                body: `## ðŸ“¦ Quarterly Dependency Review

            This is an automated quarterly check for outdated dependencies.

            ### Action Required
            - Review the [workflow run summary](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - Check for major version updates that may contain breaking changes
            - Update dependencies manually or review Dependabot PRs
            - Run \`npm outdated\` locally to see detailed information

            ### Quick Commands
            \`\`\`bash
            # See outdated packages
            npm outdated

            # Update all packages (careful with major updates!)
            npm update

            # Check for security vulnerabilities
            npm audit

            # Fix security issues automatically
            npm audit fix
            \`\`\`

            **Note:** Dependabot automatically creates PRs for minor and patch updates.
            This issue is mainly for reviewing major updates that require manual attention.
            `,
                labels: ['dependencies', 'maintenance', 'quarterly-review']
              });
            }

      - name: Upload outdated report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: |
            outdated.json
          retention-days: 90
